{% extends "base.html" %}

{% block conteudo %}
<div class="row">
    <!-- Main Column -->
    <div class="col-lg-9">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
            <div>
                <h2 class="fw-bold text-secondary mb-0">Matrículas</h2>
                <div class="btn-group mt-2">
                    <a href="{{ url_for('index', status='todos') }}"
                        class="btn btn-sm {{ 'btn-secondary' if filtro_status == 'todos' else 'btn-outline-secondary' }}">Todos</a>
                    <a href="{{ url_for('index', status='pendentes') }}"
                        class="btn btn-sm {{ 'btn-secondary' if filtro_status == 'pendentes' else 'btn-outline-secondary' }}">Pendentes</a>
                    <a href="{{ url_for('index', status='concluidos') }}"
                        class="btn btn-sm {{ 'btn-success' if filtro_status == 'concluidos' else 'btn-outline-success' }}">Concluídos</a>
                </div>
            </div>

            <form class="d-flex" method="get">
                <input class="form-control me-2" type="search" placeholder="Pesquisar matrícula, endereço..." name="q"
                    value="{{ request.args.get('q', '') }}">
                <button class="btn btn-outline-primary" type="submit">Buscar</button>
            </form>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Matrícula</th>
                                <th>Endereço</th>
                                <th>Bairro</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in imoveis %}
                            <tr class="{{ 'table-success' if i.status_trabalho == 'CONCLUIDO' else '' }}">
                                <td class="ps-4 fw-bold text-primary">
                                    {{ i.numero_registro }}
                                    {% if i.status_trabalho == 'CONCLUIDO' %}
                                    <span class="badge bg-success ms-1">OK</span>
                                    {% endif %}
                                </td>
                                <td>{{ i.nome_logradouro or '-' }}</td>
                                <td>{{ i.bairro or '-' }}</td>
                                <td class="small text-muted">
                                    {% if i.status_trabalho == 'CONCLUIDO' %}
                                    <span class="text-success fw-bold">Concluído por {{ i.concluded_by or 'Sistema'
                                        }}</span>
                                    {% elif i.is_locked %}
                                    <span class="text-danger"><i class="bi bi-lock-fill"></i> {{ i.status_texto
                                        }}</span>
                                    {% else %}
                                    <span class="text-success"><i class="bi bi-unlock-fill"></i> Livre</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            onclick="visualizar({{ i.id }})">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <!-- Botão Editar -->
                                        {% if (not i.is_locked or i.locked_by_me or current_user.role in ['admin',
                                        'supervisor']) and
                                        (i.status_trabalho != 'CONCLUIDO' or current_user.role in ['admin',
                                        'supervisor']) %}
                                        <a href="{{ url_for('editar_imovel', imovel_id=i.id) }}"
                                            class="btn btn-sm btn-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% endif %}

                                        <!-- Botão Reabrir -->
                                        {% if i.status_trabalho == 'CONCLUIDO' and current_user.role in ['admin',
                                        'supervisor'] %}
                                        <form action="{{ url_for('reabrir_imovel', imovel_id=i.id) }}" method="post"
                                            class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-warning" title="Reabrir">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                        </form>
                                        {% endif %}

                                        <!-- Botão Excluir -->
                                        {% if current_user.role == 'admin' %}
                                        <form action="{{ url_for('excluir_imovel', imovel_id=i.id) }}" method="post"
                                            class="d-inline"
                                            onsubmit="return confirm('Tem certeza que deseja excluir esta matrícula?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">Nenhum registro encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3">
        <!-- Online Users Widget -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold text-success">
                <i class="bi bi-circle-fill small me-2" style="font-size: 0.6rem;"></i> Usuários Online
            </div>
            <ul class="list-group list-group-flush">
                {% if online_users %}
                {% for u in online_users %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-medium">{{ u.username }}</span>
                        <div class="text-muted small" style="font-size: 0.7rem;">{{ u.role }}</div>
                    </div>
                    <span class="badge bg-success rounded-pill" style="width:10px; height:10px; padding:0;"></span>
                </li>
                {% endfor %}
                {% else %}
                <li class="list-group-item text-muted small text-center">Ninguém visível.</li>
                {% endif %}
            </ul>
        </div>

        <!-- Stats Mini Widget (Optional) -->
        <div class="card shadow-sm bg-body-tertiary">
            <div class="card-body text-center">
                <small class="text-muted text-uppercase fw-bold">Total Listado</small>
                <h3 class="fw-bold text-dark mb-0">{{ imoveis|length }}</h3>
            </div>
        </div>
    </div>
</div>

<script>
    function visualizar(id) {
        const url = '/imovel/' + id + '/popup';
        const w = 1200;
        const h = 800;
        const left = (screen.width - w) / 2;
        const top = (screen.height - h) / 2;
        window.open(url, 'VisualizarImovel_' + id, `width=${w},height=${h},top=${top},left=${left},resizable=yes,scrollbars=yes`);
    }
</script>
{% endblock %}